# ğŸ—ï¸ Architecture du SystÃ¨me d'Identification des Documents

## ğŸ“ Diagramme de l'Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (Client)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Page Recherche    â”‚         â”‚  Page Vue d'Ensemble        â”‚    â”‚
â”‚  â”‚  /patients         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  /patients/all              â”‚    â”‚
â”‚  â”‚                    â”‚         â”‚                             â”‚    â”‚
â”‚  â”‚  - Barre recherche â”‚         â”‚  - Stats globales           â”‚    â”‚
â”‚  â”‚  - Bouton "Voir    â”‚         â”‚  - Tableau patients         â”‚    â”‚
â”‚  â”‚    tous"           â”‚         â”‚  - Progression individuelle â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                    â”‚                     â”‚
â”‚           â”‚ (clic sur patient)                 â”‚ (clic "Voir")      â”‚
â”‚           â–¼                                    â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Page DÃ©tails Patient                                 â”‚   â”‚
â”‚  â”‚         /patients/[patientId]/documents                      â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Infos Patient    â”‚  â”‚  Statut Compact              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Card)           â”‚  â”‚  - Progression               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                   â”‚  â”‚  - Badge %                   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  PatientDocumentStatusComponent (DÃ©taillÃ©)            â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Barre progression                                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Liste catÃ©gories avec indicateurs                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Documents manquants                                 â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  PatientDocumentManager                                â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Upload de documents                                 â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Tableau des documents                               â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Actions (tÃ©lÃ©charger, supprimer)                   â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Server Actions
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (Server Actions)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  patient-actions.ts                                          â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚  identifyPatientDocuments(patientId)         â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  1. RÃ©cupÃ¨re dÃ©tails patient                 â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  2. RÃ©cupÃ¨re tous documents patient          â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  3. Groupe par catÃ©gorie                     â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  4. Calcule % complÃ©tion                     â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  5. Identifie catÃ©gories manquantes          â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  â†’ Retourne PatientDocumentStatus            â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚  identifyAllPatientsDocuments()              â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  1. RÃ©cupÃ¨re tous les patients               â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  2. Pour chaque patient:                     â”‚           â”‚   â”‚
â”‚  â”‚  â”‚     â””â”€â–¶ identifyPatientDocuments()           â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  3. Compile les rÃ©sultats                    â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  â†’ Retourne PatientDocumentStatus[]          â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  document-actions.ts                                         â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â€¢ getPatientDetails(patientId)                              â”‚   â”‚
â”‚  â”‚  â€¢ getDocumentsForPatient(patientId)                         â”‚   â”‚
â”‚  â”‚  â€¢ addDocumentMetadata(metadata)                             â”‚   â”‚
â”‚  â”‚  â€¢ deleteDocumentAction(docId, path)                         â”‚   â”‚
â”‚  â”‚  â€¢ getSignedUrlForDownload(path)                             â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Supabase Client
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SUPABASE (Backend)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Table: patients     â”‚         â”‚  Table: documents    â”‚         â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚         â”‚
â”‚  â”‚  â€¢ id (UUID)         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â€¢ id (UUID)         â”‚         â”‚
â”‚  â”‚  â€¢ full_name         â”‚    FK   â”‚  â€¢ patient_id (FK)   â”‚         â”‚
â”‚  â”‚  â€¢ email             â”‚         â”‚  â€¢ file_name         â”‚         â”‚
â”‚  â”‚  â€¢ phone             â”‚         â”‚  â€¢ storage_path      â”‚         â”‚
â”‚  â”‚  â€¢ poids             â”‚         â”‚  â€¢ file_type         â”‚         â”‚
â”‚  â”‚  â€¢ taille            â”‚         â”‚  â€¢ file_size         â”‚         â”‚
â”‚  â”‚  â€¢ bmi               â”‚         â”‚  â€¢ document_category â”‚         â”‚
â”‚  â”‚  â€¢ facture_envoye    â”‚         â”‚  â€¢ uploaded_at       â”‚         â”‚
â”‚  â”‚  â€¢ medical_agrement  â”‚         â”‚  â€¢ user_id           â”‚         â”‚
â”‚  â”‚  â€¢ consent_form      â”‚         â”‚                      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Storage Bucket: patient-documents                           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  Structure: {user_id}/{patient_id}/{timestamp}_{filename}   â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  Fichiers PDF, images, documents uploadÃ©s                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flux de DonnÃ©es

### ğŸ“¥ Flux 1 : Consultation du Statut d'un Patient

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. Visite /patients/[id]/documents
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Page Details        â”‚
â”‚ (Server Component)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 2. Appelle identifyPatientDocuments(id)
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ identifyPatientDocuments()      â”‚
â”‚ (Server Action)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3a. getPatientDetails(id)       â”‚â”€â”€â”
â”‚ 3b. getDocumentsForPatient(id)  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                          â”‚
           â–¼                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ Supabase Database   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â€¢ Query patients    â”‚
â”‚ â€¢ Query documents   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 4. Retourne donnÃ©es
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ identifyPatientDocuments()      â”‚
â”‚ â€¢ Groupe par catÃ©gorie          â”‚
â”‚ â€¢ Calcule complÃ©tion            â”‚
â”‚ â€¢ Identifie manquants           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 5. Retourne PatientDocumentStatus
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Page Details        â”‚
â”‚ â€¢ Render infos      â”‚
â”‚ â€¢ Render statut     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 6. HTML envoyÃ© au client
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser                              â”‚
â”‚ â€¢ Affiche infos patient              â”‚
â”‚ â€¢ Affiche statut compact (haut)      â”‚
â”‚ â€¢ Affiche statut dÃ©taillÃ© (milieu)   â”‚
â”‚ â€¢ Affiche gestionnaire docs (bas)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š Flux 2 : Vue d'Ensemble de Tous les Patients

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. Visite /patients/all
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Page All Patients   â”‚
â”‚ (Server Component)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 2. Appelle identifyAllPatientsDocuments()
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ identifyAllPatientsDocuments()  â”‚
â”‚ (Server Action)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 3. Query ALL patients
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Database   â”‚
â”‚ SELECT * FROM       â”‚
â”‚ patients            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 4. Retourne [patient1, patient2, ...]
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ identifyAllPatientsDocuments()  â”‚
â”‚ Pour chaque patient:            â”‚
â”‚ â”œâ”€â–¶ identifyPatientDocuments()  â”‚
â”‚ â”œâ”€â–¶ identifyPatientDocuments()  â”‚
â”‚ â””â”€â–¶ identifyPatientDocuments()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 5. Retourne [status1, status2, ...]
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Page All Patients   â”‚
â”‚ â€¢ Calcule stats     â”‚
â”‚ â€¢ Render tableau    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 6. HTML envoyÃ© au client
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser                           â”‚
â”‚ â€¢ Affiche stats globales          â”‚
â”‚ â€¢ Affiche tableau patients        â”‚
â”‚ â€¢ Barres progression individuellesâ”‚
â”‚ â€¢ Badges de statut                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¤ Flux 3 : Upload d'un Document

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. SÃ©lectionne fichier + catÃ©gorie
     â”‚ 2. Clique "Uploader"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PatientDocumentManager   â”‚
â”‚ (Client Component)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 3. handleUpload()
           â”‚    â”œâ”€ Valide fichier
           â”‚    â”œâ”€ Authentification check
           â”‚    â””â”€ Upload vers Supabase Storage
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Storage    â”‚
â”‚ Bucket: patient-    â”‚
â”‚ documents           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 4. Retourne storage_path
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ addDocumentMetadata()    â”‚
â”‚ (Server Action)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. INSERT INTO documents â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Database   â”‚
â”‚ documents table     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 6. Document enregistrÃ©
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ addDocumentMetadata()    â”‚
â”‚ â€¢ revalidatePath()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 7. Invalide cache Next.js
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Page Auto-refresh        â”‚
â”‚ â€¢ identifyPatientDocs()  â”‚
â”‚ â€¢ Nouveau calcul %       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 8. Nouveau HTML
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser                  â”‚
â”‚ â€¢ Statut mis Ã  jour      â”‚
â”‚ â€¢ Barre progression ++   â”‚
â”‚ â€¢ Nouveau doc dans liste â”‚
â”‚ â€¢ Toast success          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§® Algorithme de Calcul de ComplÃ©tion

```typescript
function calculateCompletion(documents: DocumentType[]): number {
  // 1. DÃ©finir les catÃ©gories requises (exclut "Autre")
  const REQUIRED_CATEGORIES = [
    "Facture",
    "Contrat", 
    "Simulation FinanciÃ¨re",
    "Compte Rendu Hospitalisation",
    "Compte Rendu Consultation",
    "Lettre GP",
    "Formulaire S2"
  ]
  
  // 2. Grouper les documents par catÃ©gorie
  const documentsByCategory = {}
  documents.forEach(doc => {
    const category = doc.document_category || "Autre"
    if (!documentsByCategory[category]) {
      documentsByCategory[category] = []
    }
    documentsByCategory[category].push(doc)
  })
  
  // 3. Compter les catÃ©gories complÃ¨tes
  const completedCategories = REQUIRED_CATEGORIES.filter(
    category => documentsByCategory[category]?.length > 0
  )
  
  // 4. Calculer le pourcentage
  const percentage = (completedCategories.length / REQUIRED_CATEGORIES.length) * 100
  
  // 5. Arrondir
  return Math.round(percentage)
}

// Exemples:
// - 7 catÃ©gories sur 7 â†’ 100%
// - 6 catÃ©gories sur 7 â†’ 86%
// - 0 catÃ©gorie sur 7 â†’ 0%
```

## ğŸ¨ Logique des Indicateurs Visuels

```typescript
function getVisualIndicators(categoryInfo: DocumentSummaryByCategory) {
  const hasDocuments = categoryInfo.count > 0
  const isRequired = categoryInfo.category !== "Autre"
  
  if (hasDocuments) {
    return {
      icon: "CheckCircle2",
      color: "green",
      bgClass: "bg-green-50 border-green-200",
      textClass: "text-green-600"
    }
  } else if (isRequired) {
    return {
      icon: "AlertCircle",
      color: "amber",
      bgClass: "bg-amber-50 border-amber-200",
      textClass: "text-amber-600"
    }
  } else {
    return {
      icon: "XCircle",
      color: "gray",
      bgClass: "bg-muted border-muted",
      textClass: "text-muted-foreground"
    }
  }
}
```

## ğŸ“Š Structure des DonnÃ©es RetournÃ©es

### Exemple de `PatientDocumentStatus`

```typescript
{
  patientId: "550e8400-e29b-41d4-a716-446655440000",
  patientName: "Dupont Jean",
  totalDocuments: 8,
  completionPercentage: 86,
  missingCategories: ["Formulaire S2"],
  documentsByCategory: [
    {
      category: "Facture",
      count: 2,
      documents: [
        { id: "...", file_name: "facture_jan.pdf", ... },
        { id: "...", file_name: "facture_fev.pdf", ... }
      ]
    },
    {
      category: "Contrat",
      count: 1,
      documents: [
        { id: "...", file_name: "contrat_signe.pdf", ... }
      ]
    },
    {
      category: "Simulation FinanciÃ¨re",
      count: 1,
      documents: [...]
    },
    {
      category: "Compte Rendu Hospitalisation",
      count: 2,
      documents: [...]
    },
    {
      category: "Compte Rendu Consultation",
      count: 1,
      documents: [...]
    },
    {
      category: "Lettre GP",
      count: 1,
      documents: [...]
    },
    {
      category: "Formulaire S2",
      count: 0,          // âš ï¸ Manquant
      documents: []
    },
    {
      category: "Autre",
      count: 0,
      documents: []
    }
  ]
}
```

## ğŸ” SÃ©curitÃ© et Permissions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Middleware.ts                            â”‚
â”‚ â€¢ VÃ©rifie session Supabase              â”‚
â”‚ â€¢ RafraÃ®chit token si expirÃ©            â”‚
â”‚ â€¢ AppliquÃ© sur toutes les routes        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Server Actions                           â”‚
â”‚ â€¢ Appels cÃ´tÃ© serveur uniquement        â”‚
â”‚ â€¢ "use server" directive                 â”‚
â”‚ â€¢ getUser() pour authentification        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase RLS (Row Level Security)       â”‚
â”‚ â€¢ Policies sur tables patients/documents â”‚
â”‚ â€¢ user_id check automatique              â”‚
â”‚ â€¢ Isolation des donnÃ©es par utilisateur  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Points ClÃ©s de l'Architecture

### âœ… Server Components (Next.js 15)
- Pages rendues cÃ´tÃ© serveur
- AccÃ¨s direct Ã  la base de donnÃ©es
- Pas de JS envoyÃ© au client pour la logique mÃ©tier
- SEO-friendly

### âœ… Server Actions
- Fonctions cÃ´tÃ© serveur appelables depuis client
- Alternative moderne aux API routes
- Type-safe avec TypeScript
- IntÃ©gration native avec React 19

### âœ… Client Components
- Uniquement pour interactivitÃ© (upload, modals)
- Hook `useState`, `useEffect` autorisÃ©s
- MarquÃ©s avec `"use client"`

### âœ… Optimisations Next.js
- `noStore()` : donnÃ©es fraÃ®ches sans cache
- `revalidatePath()` : invalidation ciblÃ©e
- Streaming et Suspense supportÃ©s

### âœ… Supabase Integration
- Client serveur : cookies-based
- Client browser : localStorage-based (singleton)
- Storage pour fichiers
- Auth pour sÃ©curitÃ©

---

*Architecture documentÃ©e le 2025-12-13*
